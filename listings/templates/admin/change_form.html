{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
.upload-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
    border: 2px dashed #dee2e6;
}

.upload-button {
    background: #007cba;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background 0.3s;
}

.upload-button:hover {
    background: #005a87;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #e9ecef;
}

.upload-status {
    margin-left: 15px;
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 4px;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
}

.source-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.badge-manual {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-api {
    background: #f3e5f5;
    color: #7b1fa2;
}

/* Style the multiple file input */
.field-multiple_images .upload-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 10px 0;
    border: 2px dashed #dee2e6;
}
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhance the multiple file input
    const multipleUploadField = document.querySelector('[name="multiple_images"]');
    if (multipleUploadField) {
        // Create a more user-friendly interface
        const originalField = multipleUploadField;
        const container = originalField.closest('.form-row');
        
        if (container) {
            const enhancedHTML = `
                <div class="upload-section">
                    <p><strong>Multiple Images Upload</strong></p>
                    <p>Click the button below or drag & drop multiple images:</p>
                    <button type="button" class="upload-button" id="custom-upload-button">
                        üìÅ Select Multiple Images
                    </button>
                    <span id="file-count" style="margin-left: 15px; font-weight: bold;"></span>
                    <div id="image-preview" class="image-preview-container"></div>
                    <div id="upload-status" class="upload-status"></div>
                </div>
            `;
            
            // Insert our enhanced UI
            container.innerHTML += enhancedHTML;
            originalField.style.display = 'none';
            
            // Add event listeners
            document.getElementById('custom-upload-button').addEventListener('click', function() {
                originalField.click();
            });
            
            originalField.addEventListener('change', function(e) {
                const files = e.target.files;
                const fileCount = document.getElementById('file-count');
                const preview = document.getElementById('image-preview');
                const status = document.getElementById('upload-status');
                
                if (files.length > 0) {
                    fileCount.textContent = `${files.length} image${files.length !== 1 ? 's' : ''} selected`;
                    preview.innerHTML = '';
                    status.innerHTML = '';
                    
                    // Show preview of selected images
                    for (let i = 0; i < files.length; i++) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-image';
                            img.title = files[i].name;
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(files[i]);
                    }
                    
                    // Show success message
                    status.innerHTML = `<div class="status-success">${files.length} images selected. They will be saved when you submit the form.</div>`;
                } else {
                    fileCount.textContent = '';
                    preview.innerHTML = '';
                    status.innerHTML = '';
                }
            });
            
            // Add drag and drop functionality
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.style.backgroundColor = '#e3f2fd';
            });
            
            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.style.backgroundColor = '';
            });
            
            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.style.backgroundColor = '';
                originalField.files = e.dataTransfer.files;
                
                // Trigger change event
                const event = new Event('change', { bubbles: true });
                originalField.dispatchEvent(event);
            });
        }
    }

    // Show/hide fields based on source selection
    const sourceRadios = document.querySelectorAll('input[name="source"]');
    function toggleFieldsBasedOnSource() {
        const multipleImagesSection = document.querySelector('.field-multiple_images');
        const apiIdSection = document.querySelector('.field-api_id');
        
        const selectedSource = document.querySelector('input[name="source"]:checked');
        
        if (selectedSource && selectedSource.value === 'manual') {
            if (multipleImagesSection) multipleImagesSection.style.display = 'block';
            if (apiIdSection) apiIdSection.style.display = 'none';
        } else if (selectedSource && selectedSource.value === 'api') {
            if (multipleImagesSection) multipleImagesSection.style.display = 'none';
            if (apiIdSection) apiIdSection.style.display = 'block';
        }
    }
    
    // Add change listeners to source radios
    sourceRadios.forEach(radio => {
        radio.addEventListener('change', toggleFieldsBasedOnSource);
    });
    
    // Initial call to set correct visibility
    toggleFieldsBasedOnSource();
});
</script>
{% endblock %}