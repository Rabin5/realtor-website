<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Dashboard - Admin</title>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e6ef;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.total { border-top: 4px solid #3498db; }
        .stat-card.approved { border-top: 4px solid #2ecc71; }
        .stat-card.pending { border-top: 4px solid #f39c12; }
        .stat-card.featured { border-top: 4px solid #9b59b6; }
        .stat-card.rating { border-top: 4px solid #e74c3c; }

        /* Filters */
        .filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .filters h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-control {
            padding: 8px 15px;
            border: 2px solid #e0e6ef;
            border-radius: 6px;
            font-size: 0.95rem;
            min-width: 150px;
        }

        .filter-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .filter-btn:hover {
            background: #2980b9;
        }

        /* Reviews Table */
        .reviews-table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }

        .reviews-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .reviews-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e6ef;
        }

        .reviews-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e6ef;
            vertical-align: top;
        }

        .reviews-table tr:hover {
            background-color: #f8f9fa;
        }

        .reviews-table tr.pending {
            background-color: #fff9e6;
        }

        /* Review Content */
        .review-comment {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .review-comment.expanded {
            white-space: normal;
            max-width: none;
        }

        .show-more-btn {
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 5px;
        }

        .stars {
            color: #f39c12;
            font-size: 1.1rem;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-approved { background: #d5edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }

        .featured-badge {
            background: #e8dff5;
            color: #6f42c1;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .approve-btn { background: #2ecc71; color: white; }
        .approve-btn:hover { background: #27ae60; }

        .reject-btn { background: #e74c3c; color: white; }
        .reject-btn:hover { background: #c0392b; }

        .feature-btn { background: #9b59b6; color: white; }
        .feature-btn:hover { background: #8e44ad; }

        .unfeature-btn { background: #95a5a6; color: white; }
        .unfeature-btn:hover { background: #7f8c8d; }

        .edit-btn { background: #3498db; color: white; }
        .edit-btn:hover { background: #2980b9; }

        .delete-btn { background: #e67e22; color: white; }
        .delete-btn:hover { background: #d35400; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e6ef;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(.active):not(:disabled) {
            background: #f8f9fa;
        }

        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-control {
                width: 100%;
            }
            
            .reviews-table {
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Review Management Dashboard</h1>
            <div class="header-actions">
                <p>Welcome, {{ request.user.username }} | {{ reviews.count }} total reviews</p>
                <a href="{% url 'admin:index' %}" class="logout-btn">Admin Site</a>
                <a href="{% url 'listings:home' %}" class="logout-btn">Back to Site</a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-value">{{ stats.total }}</div>
                <div class="stat-label">Total Reviews</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value">{{ stats.approved }}</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-value">{{ stats.pending }}</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card featured">
                <div class="stat-value">{{ stats.featured }}</div>
                <div class="stat-label">Featured</div>
            </div>
            <div class="stat-card rating">
                <div class="stat-value">{{ stats.avg_rating|floatformat:1 }}</div>
                <div class="stat-label">Avg Rating</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3>Filter Reviews</h3>
            <form method="GET" class="filter-group">
                <select name="status" class="filter-control">
                    <option value="">All Statuses</option>
                    <option value="approved">Approved</option>
                    <option value="pending">Pending</option>
                </select>
                
                <select name="rating" class="filter-control">
                    <option value="">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="3">3 Stars</option>
                    <option value="2">2 Stars</option>
                    <option value="1">1 Star</option>
                </select>
                
                <select name="category" class="filter-control">
                    <option value="">All Categories</option>
                    <option value="rental">Rental</option>
                    <option value="buying">Buying</option>
                    <option value="selling">Selling</option>
                    <option value="agent">Agent</option>
                    <option value="property">Property</option>
                    <option value="service">Service</option>
                </select>
                
                <select name="featured" class="filter-control">
                    <option value="">Featured & Regular</option>
                    <option value="yes">Featured Only</option>
                    <option value="no">Regular Only</option>
                </select>
                
                <button type="submit" class="filter-btn">Apply Filters</button>
                <button type="button" class="filter-btn" onclick="window.location.href='.'">Clear Filters</button>
            </form>
        </div>

        <!-- Reviews Table -->
        <div class="reviews-table-container">
            <h3>All Reviews ({{ reviews.count }})</h3>
            
            <table class="reviews-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Rating</th>
                        <th>Review</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for review in reviews %}
                    <tr class="{% if not review.is_approved %}pending{% endif %}">
                        <td>
                            <strong>{{ review.name }}</strong><br>
                            <small>{{ review.email }}</small>
                        </td>
                        <td>
                            <div class="stars">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= review.rating %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <small>{{ review.rating }}/5</small>
                        </td>
                        <td>
                            <div class="review-comment" id="comment-{{ review.id }}">
                                {{ review.comment|truncatechars:100 }}
                            </div>
                            {% if review.comment|length > 100 %}
                                <span class="show-more-btn" onclick="toggleComment({{ review.id }})">Show more</span>
                            {% endif %}
                            
                            {% if review.property_related %}
                                <div style="margin-top: 5px;">
                                    <small><strong>Property:</strong> {{ review.property_related }}</small>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            {{ review.get_category_display_name|default:"-" }}
                        </td>
                        <td>
                            {{ review.location|default:"-" }}
                        </td>
                        <td>
                            {% if review.is_approved %}
                                <span class="status-badge status-approved">Approved</span>
                            {% else %}
                                <span class="status-badge status-pending">Pending</span>
                            {% endif %}
                            
                            {% if review.featured %}
                                <br>
                                <span class="featured-badge">Featured</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ review.created_at|date:"M d, Y" }}<br>
                            <small>{{ review.created_at|timesince }} ago</small>
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if not review.is_approved %}
                                    <button class="action-btn approve-btn" onclick="approveReview('{{ review.id }}')">Approve</button>
                                {% else %}
                                    <button class="action-btn reject-btn" onclick="rejectReview('{{ review.id }}')">Reject</button>
                                {% endif %}
                                
                                {% if review.featured %}
                                    <button class="action-btn unfeature-btn" onclick="toggleFeatured('{{ review.id }}', false)">Unfeature</button>
                                {% else %}
                                    <button class="action-btn feature-btn" onclick="toggleFeatured('{{ review.id }}', true)">Feature</button>
                                {% endif %}
                                
                                <button class="action-btn edit-btn" onclick="editReview('{{ review.id }}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteReview('{{ review.id }}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            No reviews found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            {% if reviews.has_other_pages %}
            <div class="pagination">
                {% if reviews.has_previous %}
                    <button class="page-btn" onclick="window.location.href='?page={{ reviews.previous_page_number }}'">Previous</button>
                {% else %}
                    <button class="page-btn" disabled>Previous</button>
                {% endif %}

                {% for i in reviews.paginator.page_range %}
                    {% if reviews.number == i %}
                        <button class="page-btn active">{{ i }}</button>
                    {% else %}
                        <button class="page-btn" onclick="window.location.href='?page={{ i }}'">{{ i }}</button>
                    {% endif %}
                {% endfor %}

                {% if reviews.has_next %}
                    <button class="page-btn" onclick="window.location.href='?page={{ reviews.next_page_number }}'">Next</button>
                {% else %}
                    <button class="page-btn" disabled>Next</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Toggle comment expansion
        function toggleComment(reviewId) {
            const commentElement = document.getElementById(`comment-${reviewId}`);
            const button = commentElement.nextElementSibling;
            
            if (commentElement.classList.contains('expanded')) {
                commentElement.classList.remove('expanded');
                commentElement.textContent = commentElement.textContent.substring(0, 100) + '...';
                button.textContent = 'Show more';
            } else {
                // In a real application, you would fetch the full comment via AJAX
                // For now, we'll use the full text if available in a data attribute
                commentElement.classList.add('expanded');
                commentElement.textContent = commentElement.getAttribute('data-full-text') || commentElement.textContent;
                button.textContent = 'Show less';
            }
        }

        // Action functions (to be implemented with AJAX)
        function approveReview(reviewId) {
            if (confirm('Approve this review?')) {
                // AJAX call to approve review
                fetch(`/reviews/${reviewId}/approve/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function rejectReview(reviewId) {
            if (confirm('Reject this review? It will be marked as not approved.')) {
                // AJAX call to reject review
                fetch(`/reviews/${reviewId}/reject/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function toggleFeatured(reviewId, feature) {
            const action = feature ? 'Feature' : 'Unfeature';
            if (confirm(`${action} this review?`)) {
                fetch(`/reviews/${reviewId}/toggle-featured/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ featured: feature })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function editReview(reviewId) {
            window.location.href = `/admin/reviews/${reviewId}/edit/`;
        }

        function deleteReview(reviewId) {
            if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
                fetch(`/reviews/${reviewId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Add data attributes for full comments
        document.addEventListener('DOMContentLoaded', function() {
            const commentElements = document.querySelectorAll('.review-comment');
            commentElements.forEach(element => {
                // In a real application, you would set this from Django template
                // element.setAttribute('data-full-text', '{{ review.comment|escapejs }}');
            });
        });
    </script>
</body>
</html>